#!/usr/bin/env bash
set -euo pipefail
trap 'echo "✖ Unexpected error on line $LINENO"; exit 1' ERR

#####################################
# Pre checks - never tested this sec
#####################################

# Color constants
RED="\033[1;31m"
CYAN="\033[1;36m"
RESET="\033[0m"

MS=$(date +%s%N | cut -b1-13)

# Helpers
error() {
  echo -e "$*" >&2
  exit 1
}
info() {
  echo -e "→ $*"
}

# Prerequisite
if ! command -v curl >/dev/null; then
  error "${RED}USER ACTION REQUIRED:${RESET} Install curl (e.g. brew install curl or apt-get install curl)."
fi

# Verify endpint
DATASET="catalog"
ENDPOINT="http://localhost:3030/$DATASET/query"
info "Verifying Fuseki $DATASET at $ENDPOINT"

HTTP_CODE=$(curl -sS -G \
  --data-urlencode 'query=ASK WHERE { }' \
  -o /dev/null -w "%{http_code}" \
  "$ENDPOINT" || echo "000")

if [[ "$HTTP_CODE" != "200" ]]; then
  echo -e "${RED}USER ACTION REQUIRED:${RESET} Open a new terminal and run ${CYAN}yarn start:store${RESET} to start Jena"
  echo -e "Then try again."
  exit 1
fi

info "Fuseki $DATASET is running (HTTP $HTTP_CODE)."


#####################################
# Actual script
#####################################

printf "Clear data in $DATASET [y/N]?: "
read -r ans

if [[ "$ans" =~ ^[Yy]$ ]]; then
  ./scripts/jena-helper wipeDataSet "$DATASET"
else
  echo "Keeping existing data"
fi

./scripts/.dev/task/task-import-triples-from-file -l http://localhost:3030/catalog/query -i ./data/phase2v2.nt

./scripts/jena-helper q-dataSetAll catalog